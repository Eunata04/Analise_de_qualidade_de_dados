üöÄ MVP - Guia Completo de Implementa√ß√£o
üìã PR√â-REQUISITOS (Verificar ANTES de come√ßar)
‚úÖ Checklist:

 Acesso administrativo ao SharePoint
 Acesso ao Power Automate (licen√ßa b√°sica do M365)
 Acesso ao Databricks com permiss√£o para gerar tokens
 Conta com permiss√£o para criar Flows no Power Automate

üîç Informa√ß√µes que voc√™ vai precisar coletar:

URL do seu SharePoint: https://suaempresa.sharepoint.com/sites/NomeSite
Databricks Workspace URL: https://xxxxx.azuredatabricks.net
Warehouse ID do Databricks (vou ensinar a pegar)
Token de acesso do Databricks (vou ensinar a gerar)
Nome das tabelas/listas que existem (lista_verde, lista_amarela, etc.)


üìÖ CRONOGRAMA DO MVP (3 dias)

Dia 1 (2h): SharePoint List + Databricks Setup
Dia 2 (3h): Power Automate Flow
Dia 3 (2h): Testes + Ajustes


üóìÔ∏è DIA 1 - FUNDA√á√ÉO
PARTE 1: Criar SharePoint List (30 min)
Passo 1: Criar a lista

Acesse seu site SharePoint: https://suaempresa.sharepoint.com/sites/SeuSite
Clique em "Conte√∫do do site" (menu lateral esquerdo)
Clique em "+ Novo" ‚Üí "Lista"
Escolha "Lista em branco"
Nome: Regras_Fraude
Descri√ß√£o: Sistema de regras de detec√ß√£o de fraudes
Clique em "Criar"

Passo 2: Adicionar colunas (uma por uma)
COLUNA 1 - Nome_Regra (j√° existe como "T√≠tulo", vamos renomear)

Clique em "Adicionar coluna" ‚Üí Renomear coluna existente "T√≠tulo"
Novo nome: Nome_Regra

COLUNA 2 - Campo_1

Clique em "+ Adicionar coluna" ‚Üí "Escolha"
Nome: Campo_1
Escolhas (uma por linha):

   cod_prestador
   cod_procedimento
   cod_beneficiario
   valor_transacao
   data_transacao
   segmentacao
   Custo_ITEM

Formato: Menu suspenso
Valor padr√£o: cod_prestador
Salvar

COLUNA 3 - Operador_1

"+ Adicionar coluna" ‚Üí "Escolha"
Nome: Operador_1
Escolhas:

   est√° na lista
   √© igual a
   √© diferente de
   √© maior que
   √© menor que
   cont√©m

Formato: Menu suspenso
Valor padr√£o: est√° na lista
Salvar

COLUNA 4 - Valor_1

"+ Adicionar coluna" ‚Üí "Escolha"
Nome: Valor_1
Escolhas:

   lista_verde
   lista_amarela
   lista_vermelha
   lista_laranja
   [valor_livre]

Formato: Menu suspenso
Permitir sele√ß√µes de preenchimento: Sim (importante!)
Salvar

COLUNA 5 - Campo_2

Repetir processo da COLUNA 2
Nome: Campo_2
Mesmas escolhas

COLUNA 6 - Operador_2

Repetir processo da COLUNA 3
Nome: Operador_2

COLUNA 7 - Valor_2

Repetir processo da COLUNA 4
Nome: Valor_2

COLUNA 8 - Segmentacao_Obrigatoria

"+ Adicionar coluna" ‚Üí "Texto"
Nome: Segmentacao_Obrigatoria
Tipo: Uma linha de texto
Salvar

COLUNA 9 - Excluir_Custo_ITEM

"+ Adicionar coluna" ‚Üí "Texto"
Nome: Excluir_Custo_ITEM
Tipo: V√°rias linhas de texto
Salvar

COLUNA 10 - Status

"+ Adicionar coluna" ‚Üí "Escolha"
Nome: Status
Escolhas:

   Rascunho
   Executar
   Executando
   Conclu√≠da
   Erro

Formato: Menu suspenso
Valor padr√£o: Rascunho
Salvar

COLUNA 11 - SQL_Gerado

"+ Adicionar coluna" ‚Üí "Texto"
Nome: SQL_Gerado
Tipo: V√°rias linhas de texto
Salvar

COLUNA 12 - Link_Resultado

"+ Adicionar coluna" ‚Üí "Hiperlink"
Nome: Link_Resultado
Salvar

COLUNA 13 - Qtd_Registros

"+ Adicionar coluna" ‚Üí "N√∫mero"
Nome: Qtd_Registros
Salvar

COLUNA 14 - Data_Execucao

"+ Adicionar coluna" ‚Üí "Data e hora"
Nome: Data_Execucao
Incluir hora: Sim
Salvar

COLUNA 15 - Mensagem_Erro

"+ Adicionar coluna" ‚Üí "Texto"
Nome: Mensagem_Erro
Tipo: V√°rias linhas de texto
Salvar

Passo 3: Criar item de teste

Clique em "+ Novo"
Preencha:

Nome_Regra: Teste Inicial
Campo_1: cod_prestador
Operador_1: est√° na lista
Valor_1: lista_verde
Campo_2: cod_procedimento
Operador_2: est√° na lista
Valor_2: lista_amarela
Segmentacao_Obrigatoria: SPADT
Excluir_Custo_ITEM: Autorizado, ETL, limiar
Status: Rascunho


Salvar

‚úÖ Checkpoint: SharePoint List criada com 15 colunas e 1 item de teste

PARTE 2: Configurar Databricks (30 min)
Passo 1: Gerar Personal Access Token

Acesse seu Databricks: https://xxxxx.azuredatabricks.net
Clique no seu perfil (canto superior direito)
Clique em "User Settings"
Aba "Developer" ou "Access Tokens"
Clique em "Generate New Token"
Configura√ß√µes:

Comment: Power Automate Integration
Lifetime: 90 days (ou sem expira√ß√£o se permitido)


Clique em "Generate"
‚ö†Ô∏è COPIE O TOKEN AGORA (n√£o vai aparecer de novo!)
Salve em local seguro: dapi1234567890abcdef...

Passo 2: Pegar Warehouse ID

No Databricks, menu lateral: "SQL Warehouses"
Selecione o warehouse que vai usar (ou crie um novo)
Clique no warehouse
Na URL, copie o ID:

   https://xxxxx.azuredatabricks.net/sql/warehouses/a1b2c3d4e5f6
                                                    ^^^^^^^^^^^^^^^^^
                                                    Este √© o ID

Salve: Warehouse ID: a1b2c3d4e5f6

Passo 3: Testar API manualmente (opcional mas recomendado)

Abra o Postman ou Insomnia (ou use curl)
Configure request:

   POST https://xxxxx.azuredatabricks.net/api/2.0/sql/statements/
   
   Headers:
   Authorization: Bearer dapi1234567890abcdef...
   Content-Type: application/json
   
   Body:
   {
     "warehouse_id": "a1b2c3d4e5f6",
     "statement": "SELECT 1 as teste",
     "wait_timeout": "10s"
   }

Clique Send
Deve retornar status 200 e resultado com "state": "SUCCEEDED"

‚úÖ Checkpoint: Token e Warehouse ID funcionando

PARTE 3: Criar biblioteca no SharePoint para resultados (15 min)

No SharePoint, "Conte√∫do do site"
"+ Novo" ‚Üí "Biblioteca de documentos"
Nome: Resultados_Regras
Criar
Criar pastas:

2026
Dentro de 2026: 01, 02, 03, etc (meses)



‚úÖ Checkpoint: Estrutura completa de armazenamento

üóìÔ∏è DIA 2 - AUTOMA√á√ÉO
PARTE 4: Criar Power Automate Flow (2-3h)
Passo 1: Criar novo Flow

Acesse: https://make.powerautomate.com
Menu lateral: "Meus fluxos"
"+ Novo fluxo" ‚Üí "Fluxo de nuvem automatizado"
Nome: Execu√ß√£o Autom√°tica de Regras de Fraude
Trigger: Busque por SharePoint
Selecione: "Quando um item √© criado ou modificado"
Criar

Passo 2: Configurar Trigger

Endere√ßo do Site: Cole a URL do seu SharePoint
Nome da Lista: Selecione Regras_Fraude
Clique em "Mostrar op√ß√µes avan√ßadas"
Em "Limit Columns by View": deixe em branco (vai usar todas)

Passo 3: Adicionar Condi√ß√£o - Verificar Status

"+ Nova etapa"
Busque: Condi√ß√£o
Selecione: "Condi√ß√£o" (Controle)
Configure:

Primeira caixa: Clique e selecione "Status" (do conte√∫do din√¢mico)
Operador: √© igual a
Segunda caixa: Executar



‚ö†Ô∏è IMPORTANTE: Todas as pr√≥ximas a√ß√µes v√£o dentro do "Se sim" desta condi√ß√£o!
Passo 4: Atualizar Status para "Executando"

Dentro do "Se sim", clique "Adicionar uma a√ß√£o"
Busque: SharePoint
Selecione: "Atualizar item"
Configure:

Endere√ßo do Site: (mesmo do trigger)
Nome da Lista: Regras_Fraude
ID: Selecione "ID" do conte√∫do din√¢mico
Status: Executando



Passo 5: Inicializar Vari√°vel - SQL

"Adicionar uma a√ß√£o"
Busque: Vari√°veis
Selecione: "Inicializar vari√°vel"
Configure:

Nome: SQL_Query
Tipo: String
Valor: (deixe em branco por enquanto)



Passo 6: Construir SQL - Parte 1 (Condi√ß√µes)

"Adicionar uma a√ß√£o"
Busque: Vari√°veis
Selecione: "Definir vari√°vel"
Configure:

Nome: SQL_Query
Valor: (cole isso e adapte):



SELECT * FROM transacoes WHERE
Passo 7: Adicionar Condi√ß√£o do Campo_1

"Adicionar uma a√ß√£o"
Busque: Compor (Opera√ß√µes de dados)
Selecione: "Compor"
Entradas: (construa assim usando conte√∫do din√¢mico)

@{variables('SQL_Query')} @{triggerOutputs()?['body/Campo_1']} IN (SELECT cod FROM @{triggerOutputs()?['body/Valor_1']})

"Adicionar uma a√ß√£o"
"Definir vari√°vel"

Nome: SQL_Query
Valor: @{outputs('Compor')}



Passo 8: Adicionar Condi√ß√£o do Campo_2

"Adicionar uma a√ß√£o"
"Compor"
Entradas:

@{variables('SQL_Query')} AND @{triggerOutputs()?['body/Campo_2']} IN (SELECT cod FROM @{triggerOutputs()?['body/Valor_2']})

"Adicionar uma a√ß√£o"
"Definir vari√°vel"

Nome: SQL_Query
Valor: @{outputs('Compor_2')}



Passo 9: Adicionar Segmenta√ß√£o

"Adicionar uma a√ß√£o"
"Compor"
Entradas:

@{variables('SQL_Query')} AND segmentacao = '@{triggerOutputs()?['body/Segmentacao_Obrigatoria']}'

"Definir vari√°vel"

Nome: SQL_Query
Valor: @{outputs('Compor_3')}



Passo 10: Adicionar Exclus√£o de Custo_ITEM

"Adicionar uma a√ß√£o"
"Compor"
Entradas:

@{variables('SQL_Query')} AND Custo_ITEM NOT IN ('@{replace(triggerOutputs()?['body/Excluir_Custo_ITEM'], ',', "','")}')

"Definir vari√°vel"

Nome: SQL_Query
Valor: @{outputs('Compor_4')}



Passo 11: Executar no Databricks

"Adicionar uma a√ß√£o"
Busque: HTTP
Selecione: "HTTP" (Premium n√£o √© necess√°rio!)
Configure:

M√©todo: POST
URI: https://xxxxx.azuredatabricks.net/api/2.0/sql/statements/
Cabe√ßalhos:



     Authorization: Bearer dapi1234567890abcdef...
     Content-Type: application/json

Corpo:

json     {
       "warehouse_id": "a1b2c3d4e5f6",
       "statement": "@{variables('SQL_Query')}",
       "wait_timeout": "30s",
       "disposition": "INLINE",
       "format": "JSON_ARRAY"
     }
Passo 12: Analisar JSON do Databricks

"Adicionar uma a√ß√£o"
Busque: Analisar JSON
Selecione: "Analisar JSON" (Opera√ß√µes de dados)
Conte√∫do: @{body('HTTP')}
Esquema: Cole este schema:

json{
    "type": "object",
    "properties": {
        "statement_id": {"type": "string"},
        "status": {
            "type": "object",
            "properties": {
                "state": {"type": "string"}
            }
        },
        "result": {
            "type": "object",
            "properties": {
                "row_count": {"type": "integer"},
                "data_array": {
                    "type": "array"
                }
            }
        }
    }
}
Passo 13: Criar Tabela CSV/Excel

"Adicionar uma a√ß√£o"
Busque: Criar tabela CSV
Selecione: "Criar tabela CSV"
De: @{body('Analisar_JSON')?['result']?['data_array']}

Passo 14: Criar arquivo no SharePoint

"Adicionar uma a√ß√£o"
Busque: SharePoint
Selecione: "Criar arquivo"
Configure:

Endere√ßo do Site: (seu SharePoint)
Caminho da Pasta: /Resultados_Regras/2026/@{formatDateTime(utcNow(), 'MM')}
Nome do Arquivo: Resultado_@{triggerOutputs()?['body/Nome_Regra']}_@{formatDateTime(utcNow(), 'yyyyMMdd_HHmmss')}.csv
Conte√∫do do Arquivo: @{body('Criar_tabela_CSV')}



Passo 15: Atualizar SharePoint com Sucesso

"Adicionar uma a√ß√£o"
"Atualizar item" (SharePoint)
Configure:

ID: @{triggerOutputs()?['body/ID']}
Status: Conclu√≠da
SQL_Gerado: @{variables('SQL_Query')}
Link_Resultado: @{body('Criar_arquivo')?['Path']}
Qtd_Registros: @{body('Analisar_JSON')?['result']?['row_count']}
Data_Execucao: @{utcNow()}



Passo 16: Enviar Email de Sucesso

"Adicionar uma a√ß√£o"
Busque: Enviar um email (V2) (Office 365 Outlook)
Configure:

Para: @{triggerOutputs()?['body/Author']?['Email']}
Assunto: ‚úÖ Regra "@{triggerOutputs()?['body/Nome_Regra']}" executada com sucesso
Corpo: (cole e ajuste formata√ß√£o):



html<p>Ol√° <strong>@{triggerOutputs()?['body/Author']?['DisplayName']}</strong>,</p>

<p>Sua regra de fraude foi executada com sucesso!</p>

<h3>üìä Resumo:</h3>
<ul>
  <li><strong>Total de registros:</strong> @{body('Analisar_JSON')?['result']?['row_count']} hits</li>
  <li><strong>Data/hora:</strong> @{formatDateTime(utcNow(), 'dd/MM/yyyy HH:mm')}</li>
</ul>

<h3>üì• Resultado:</h3>
<p><a href="@{body('Criar_arquivo')?['LinkingUrl']}">Clique aqui para baixar o arquivo</a></p>

<h3>üìù SQL Executado:</h3>
<pre>@{variables('SQL_Query')}</pre>

<hr>
<p><small>Este email foi gerado automaticamente pelo Sistema de Regras de Fraude</small></p>
```

### **Passo 17: Configurar tratamento de erro**
1. No **"Se n√£o"** da condi√ß√£o principal (l√° do in√≠cio), adicione:
2. **"Atualizar item"**
   - Status: `Erro`
   - Mensagem_Erro: `Status deve estar em "Executar" para executar a regra`

### **Passo 18: Adicionar Scope para erro de execu√ß√£o**
1. ANTES do "Atualizar SharePoint com Sucesso", adicione:
2. Busque: `Escopo` (Controle)
3. Selecione: **"Escopo"**
4. Mova TODAS as a√ß√µes de Databricks at√© Email para DENTRO do Escopo
5. Depois do Escopo, clique **"..."** ‚Üí **"Configurar execu√ß√£o ap√≥s"**
6. Marque: `falhou`, `expirou`, `foi ignorada`
7. Adicione:
   - **"Atualizar item"**
     - Status: `Erro`
     - Mensagem_Erro: `@{body('HTTP')?['message']}`
   - **"Enviar um email (V2)"**
     - Assunto: `‚ùå Erro ao executar regra`
     - Corpo: `Houve um erro: @{body('HTTP')?['message']}`

### **Passo 19: Salvar e Testar**
1. Clique em **"Salvar"** (canto superior direito)
2. Aguarde salvar completamente

‚úÖ **Checkpoint:** Flow criado e salvo

---

# üóìÔ∏è **DIA 3 - TESTES E AJUSTES**

## **PARTE 5: Testar o MVP (1-2h)**

### **Teste 1: Execu√ß√£o B√°sica**
1. Volte para SharePoint List: `Regras_Fraude`
2. Abra o item **"Teste Inicial"**
3. Mude Status para: `Executar`
4. **Salvar**
5. Aguarde 30-60 segundos
6. Atualize a p√°gina
7. Verifique:
   - ‚úÖ Status mudou para "Conclu√≠da"?
   - ‚úÖ SQL_Gerado foi preenchido?
   - ‚úÖ Link_Resultado tem URL?
   - ‚úÖ Qtd_Registros tem n√∫mero?
   - ‚úÖ Recebeu email?

### **Teste 2: Verificar Arquivo**
1. Clique no Link_Resultado
2. Arquivo CSV foi criado?
3. Abra o arquivo
4. Dados corretos?

### **Teste 3: Criar Nova Regra do Zero**
1. Na lista, clique **"+ Novo"**
2. Preencha todos os campos
3. Status: `Executar`
4. **Salvar**
5. Repita verifica√ß√µes do Teste 1

### **Teste 4: Erro Proposital**
1. Crie nova regra
2. Valor_1: coloque algo que n√£o existe: `lista_inexistente`
3. Status: `Executar`
4. **Salvar**
5. Verifique:
   - ‚úÖ Status mudou para "Erro"?
   - ‚úÖ Mensagem_Erro foi preenchida?
   - ‚úÖ Recebeu email de erro?

---

## **PARTE 6: Ajustes e Melhorias (1h)**

### **Ajuste 1: Melhorar formato do SQL**
1. No Power Automate, edite o Flow
2. Na a√ß√£o final "Definir vari√°vel" (SQL_Query), adicione quebras de linha:
```
SELECT * 
FROM transacoes 
WHERE @{triggerOutputs()?['body/Campo_1']} IN (SELECT cod FROM @{triggerOutputs()?['body/Valor_1']})
  AND @{triggerOutputs()?['body/Campo_2']} IN (SELECT cod FROM @{triggerOutputs()?['body/Valor_2']})
  AND segmentacao = '@{triggerOutputs()?['body/Segmentacao_Obrigatoria']}'
  AND Custo_ITEM NOT IN ('@{replace(triggerOutputs()?['body/Excluir_Custo_ITEM'], ',', "','")}')
Ajuste 2: Adicionar timeout no loop
(Se Databricks demorar, adicionar verifica√ß√£o de status)

Ap√≥s "HTTP" do Databricks
Adicione "At√©" (loop):

Condi√ß√£o: @{body('HTTP')?['status']?['state']} igual a SUCCEEDED
Dentro do loop:

"Atrasar": 2 segundos
"HTTP - GET": checar status da query


Limite: 20 itera√ß√µes



Ajuste 3: Formatar email melhor

No email de sucesso, melhore o HTML
Adicione logo da empresa
Cores corporativas


PARTE 7: Documenta√ß√£o para Usu√°rios (30 min)
Criar doc de 1 p√°gina:
markdown# üìò Como Criar Regras de Fraude

## 1. Acesse a Lista
https://suaempresa.sharepoint.com/sites/SeuSite/Lists/Regras_Fraude

## 2. Clique em "+ Novo"

## 3. Preencha:
- **Nome da Regra**: Descri√ß√£o clara (ex: "Prestador Verde + Proc Amarelo")
- **Campo_1**: Escolha o campo (ex: cod_prestador)
- **Operador_1**: Escolha a condi√ß√£o (ex: est√° na lista)
- **Valor_1**: Escolha o valor (ex: lista_verde)
- **Campo_2**: Segundo campo
- **Operador_2**: Segunda condi√ß√£o
- **Valor_2**: Segundo valor
- **Segmenta√ß√£o Obrigat√≥ria**: Ex: SPADT
- **Excluir Custo_ITEM**: Ex: Autorizado, ETL, limiar
- **Status**: Escolha "Executar" para rodar imediatamente

## 4. Clique em "Salvar"

## 5. Aguarde 1-2 minutos
Voc√™ receber√° um email com o resultado!

## 6. Acesse o arquivo
O email ter√° um link para baixar o CSV com os resultados.

---

**D√∫vidas?** Contate: suporte@empresa.com
Salve como PDF e compartilhe.

PARTE 8: Monitoramento (opcional)
Criar Dashboard Power BI:

Power BI Desktop
Conectar ao SharePoint List
Criar visualiza√ß√µes:

Total de regras por status
Regras mais executadas
Tempo m√©dio de execu√ß√£o
Total de hits por dia


Publicar no Power BI Service


‚úÖ CHECKLIST FINAL DO MVP

 SharePoint List criada com 15 colunas
 Item de teste criado
 Token Databricks gerado e testado
 Warehouse ID identificado
 Biblioteca Resultados_Regras criada
 Power Automate Flow criado e salvo
 Teste 1 passou (execu√ß√£o b√°sica)
 Teste 2 passou (arquivo criado)
 Teste 3 passou (nova regra)
 Teste 4 passou (tratamento de erro)
 Email de sucesso funcionando
 Email de erro funcionando
 Documenta√ß√£o criada
 2-3 usu√°rios piloto treinados


üéØ PR√ìXIMOS PASSOS (Ap√≥s MVP)
Semana 2:

 Adicionar mais campos de filtro (Campo_3, Campo_4)
 Criar templates de regras comuns
 Agendamento de regras (di√°rio, semanal)
 Hist√≥rico de execu√ß√µes

M√™s 2:

 Dashboard Power BI
 Alertas autom√°ticos (ex: se > 100 hits)
 Aprova√ß√£o de regras cr√≠ticas
 Exportar para Excel formatado (n√£o s√≥ CSV)


üìû SUPORTE DURANTE IMPLEMENTA√á√ÉO
Se travar em algum passo, me mande:

Print da tela onde travou
Mensagem de erro (se houver)
Qual passo estava fazendo
